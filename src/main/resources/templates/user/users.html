<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>User List</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f4f4f4; }
        img { width: 50px; height: 50px; border-radius: 50%; }
        button { padding: 5px 10px; margin-right: 5px; cursor: pointer; }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            min-width: 300px;
        }
        .modal input {
            padding: 8px;
            margin: 10px 0;
            width: 100%;
        }
        .modal button {
            padding: 8px 12px;
            margin-top: 10px;
        }
    </style>
    <script>
        let selectedUserId = null;

        function openDeleteModal(button) {
            selectedUserId = button.getAttribute("data-id");
            console.log("ì„ íƒëœ ìœ ì € ID:", selectedUserId); // ğŸ”¥ ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€

            let modal = document.getElementById("deleteModal");
            modal.style.display = "flex"; // ğŸ”¥ ëª¨ë‹¬ì„ í™”ë©´ì— í‘œì‹œ
        }



        function closeDeleteModal() {
            document.getElementById("deleteModal").style.display = "none";
        }

        function deleteUser() {
            if (!selectedUserId) {
                alert("ğŸš¨ ì‚¬ìš©ì IDê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤!");
                return;
            }

            let password = document.getElementById("passwordInput").value;
            if (!password) {
                alert("ğŸ”‘ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”!");
                return;
            }

            fetch(`/api/v1/user/${selectedUserId}?password=${encodeURIComponent(password)}`, {
                method: "DELETE"
            })
                .then(response => {
                    if (response.ok) {
                        return response.text();
                    } else {
                        return response.text().then(errorMessage => {
                            throw new Error(errorMessage || "âŒ ì‚­ì œ ì‹¤íŒ¨!");
                        });
                    }
                })
                .then(redirectUrl => {
                    alert("âœ… ì‚¬ìš©ìê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    window.location.href = redirectUrl;
                })
                .catch(error => {
                    console.error("ğŸš¨ ì‚­ì œ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                    alert(error.message || "âš ï¸ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                });
        }



    </script>
</head>
<body>

<h2>User List</h2>

<table>
    <thead>
    <tr>
        <th>ID</th>
        <th>Username</th>
        <th>Email</th>
        <th>Nickname</th>
        <th>Phone</th>
        <th>Created At</th>
        <th>Last Online</th>
        <th>Status</th>
        <th>Profile Picture</th>
        <th>Actions</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="user : ${users}">
        <td>
            <a th:href="@{/api/v1/user/{id}(id=${user.userId})}" th:text="${user.userId}" style="color: blue; text-decoration: underline; cursor: pointer;"></a>
        </td>
        <td th:text="${user.username}"></td>
        <td th:text="${user.email}"></td>
        <td th:text="${user.nickname}"></td>
        <td th:text="${user.phoneNumber}"></td>
        <td th:text="${#temporals.format(user.createdAt, 'yyyy-MM-dd HH:mm:ss')}"></td>
        <td th:text="${#temporals.format(user.lastOnlineAt, 'yyyy-MM-dd HH:mm:ss')}"></td>
        <td th:text="${user.userStatus}"></td>
        <td>
            <img th:if="${user.profilePictureBase64}" th:src="'data:image/png;base64,' + ${user.profilePictureBase64}" alt="Profile Image"/>
            <span th:unless="${user.profilePictureBase64}">No Image</span>
        </td>
        <td>
            <a th:href="@{/api/v1/user-update-form/{id}(id=${user.userId})}">
                <button>ìˆ˜ì •</button>
            </a>

            <button th:data-id="${user.userId}" onclick="openDeleteModal(this)">ì‚­ì œ</button>

        </td>
    </tr>
    </tbody>
</table>

<!-- ğŸ”¥ ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
<div id="deleteModal" class="modal">
    <div class="modal-content">
        <h3>ë¹„ë°€ë²ˆí˜¸ ì…ë ¥</h3>
        <p>ì‚­ì œí•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
        <input type="password" id="passwordInput" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
        <button onclick="deleteUser()">í™•ì¸</button>
        <button onclick="closeDeleteModal()">ì·¨ì†Œ</button>
    </div>
</div>

</body>
</html>
