// API ì—”ë“œí¬ì¸íŠ¸
const API_BASE_URL ='http://localhost:8080'; // ì‹¤ì œ API URLì„ ë„£ì–´ì•¼ í•©ë‹ˆë‹¤
const ENDPOINTS = {
    USERS: `${API_BASE_URL}/users`,
    CHANNELS: `${API_BASE_URL}/channels/all`,
    USER_STATUS: (id) => `${API_BASE_URL}/users/${id}/status`,
    CHANNEL_STATUS: (id) => `${API_BASE_URL}/channels/${id}/status`,
};

// í˜ì´ì§€ë„¤ì´ì…˜ ê´€ë ¨ ë³€ìˆ˜
let currentPage = 1; // í˜„ì¬ í˜ì´ì§€ (ê¸°ë³¸ê°’: 1)
const itemsPerPage = 3; // í˜ì´ì§€ë‹¹ í•­ëª© ìˆ˜

// DOMContentLoaded ì‹œ, ì‚¬ìš©ì ëª©ë¡ê³¼ ì±„ë„ ëª©ë¡ì„ ëª¨ë‘ ë¶ˆëŸ¬ì˜¤ê¸°
document.addEventListener('DOMContentLoaded', () => {
    fetchAndRenderUsers();
    fetchAndRenderChannels();
});

// ì‚¬ìš©ì ëª©ë¡ì„ APIì—ì„œ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
async function fetchAndRenderUsers() {
    const userListElement = document.getElementById('userList');
    userListElement.innerHTML = '<p>ë¡œë”© ì¤‘...</p>'; // ë¡œë”© ë©”ì‹œì§€

    try {
        const response = await fetch(ENDPOINTS.USERS);
        if (!response.ok) throw new Error('ì‚¬ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');

        const users = await response.json();
        if (users.length === 0) {
            userListElement.innerHTML = '<p>ë“±ë¡ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        } else {
            renderUserList(users);
        }
    } catch (error) {
        console.error('ì‚¬ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì˜¤ë¥˜ ë°œìƒ:', error);
        userListElement.innerHTML = '<p>ì‚¬ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
    }
}

// ì±„ë„ ëª©ë¡ì„ APIì—ì„œ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
async function fetchAndRenderChannels() {
    const channelListElement = document.getElementById('channelList');
    channelListElement.innerHTML = '<p>ë¡œë”© ì¤‘...</p>'; // ë¡œë”© ë©”ì‹œì§€

    try {
        const response = await fetch(ENDPOINTS.CHANNELS);
        if (!response.ok) throw new Error('ì±„ë„ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');

        const channels = await response.json();

        if (channels.length === 0) {
            channelListElement.innerHTML = '<p>ë“±ë¡ëœ ì±„ë„ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        } else {
            renderChannelList(channels);
        }
    } catch (error) {
        console.error('ì±„ë„ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì˜¤ë¥˜ ë°œìƒ:', error);
        channelListElement.innerHTML = '<p>ì±„ë„ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
    }
}

async function fetchImageData(profileId) {
    const response = await fetch(`http://localhost:8080/binary-content/${profileId}`);
    const imageBlob = await response.blob();
    const imageUrl = URL.createObjectURL(imageBlob);

    return imageUrl;
}
// ì‚¬ìš©ì ëª©ë¡ ë Œë”ë§ í•¨ìˆ˜
async function renderUserList(users) {
    const userListElement = document.getElementById('userList');
    userListElement.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”

    // ì‚¬ìš©ì ëª©ë¡ ë Œë”ë§ (5ê°œì”© ë‚˜ëˆ„ê¸°)
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const usersToDisplay = users.slice(startIndex, endIndex);

    for (const user of usersToDisplay) {
        const userElement = document.createElement('div');
        userElement.className = 'user-item';

        // ê¸°ë³¸ í”„ë¡œí•„ ì´ë¯¸ì§€ URL
        let profileImage = 'https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&f=y&s=50';

        if (user.profileId) {
            // ì´ë¯¸ì§€ ë°ì´í„°ê°€ ë¹„ë™ê¸°ì ìœ¼ë¡œ ë¡œë“œë˜ë¯€ë¡œ awaitë¥¼ ì‚¬ìš©í•˜ì—¬ ì²˜ë¦¬
            profileImage = await fetchImageData(user.profileId);
        }

        userElement.innerHTML = `
            <div class="user-info">
                <img src="${profileImage}" alt="${user.name}'s profile" class="profile-image" />
                <div class="user-datails">
                    <div class="user-name">${user.name}</div>
                    <div class="user-email">${user.email}</div>
                </div>
            </div>
            <div class="status-badge ${user.online ? 'online' : 'offline'}" data-user-id="${user.id}">
                ${user.online ? 'ğŸŸ¢ ì˜¨ë¼ì¸' : 'ğŸ”´ ì˜¤í”„ë¼ì¸'}
            </div>
        `;

        // ìƒíƒœ ë³€ê²½ ì´ë²¤íŠ¸
        const statusBadge = userElement.querySelector('.status-badge');
        statusBadge.addEventListener('click', () => toggleStatus(user.id, user.online, statusBadge, 'user'));

        userListElement.appendChild(userElement);
    }

    // í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ ìƒì„±
    renderPaginationButtons(users.length);
}

// ì±„ë„ ëª©ë¡ ë Œë”ë§ í•¨ìˆ˜ (5ê°œì”© ë‚˜ëˆ„ì–´ ë Œë”ë§)
function renderChannelList(channels) {
    const channelListElement = document.getElementById('channelList');
    channelListElement.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”

    // ì±„ë„ì„ 5ê°œì”© ë‚˜ëˆ„ê¸°
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const channelsToDisplay = channels.slice(startIndex, endIndex);

    for (const channel of channelsToDisplay) {
        const channelElement = document.createElement('div');
        channelElement.className = 'channel-item';

        // ì±„ë„ íƒ€ì…ì— ë”°ë¥¸ êµ¬ë¶„ (public ë˜ëŠ” private)
        const channelType = channel.type === 'PUBLIC' ? 'ğŸ”µ ê³µê°œ ì±„ë„' : 'ğŸŸ¢ ë¹„ê³µê°œ ì±„ë„';

        channelElement.innerHTML = `
            <div class="channel-info">
                <div class="channel-type">${channelType}</div>
                <div class="channel-name">${channel.channelName || 'ì±„ë„ ì´ë¦„ ì—†ìŒ'}</div>
                <div class="channel-description">${channel.description || "NO description"}</div>
            </div>
        `;

        channelListElement.appendChild(channelElement);
    }

    // í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ ìƒì„±
    renderPaginationButtons(channels.length);
}

// í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ ë Œë”ë§ í•¨ìˆ˜
function renderPaginationButtons(totalItems) {
    const paginationElement = document.getElementById('pagination');
    paginationElement.innerHTML = ''; // ê¸°ì¡´ ë²„íŠ¼ ì´ˆê¸°í™”

    const totalPages = Math.ceil(totalItems / itemsPerPage);

    // "ì´ì „" ë²„íŠ¼
    if (currentPage > 1) {
        const prevButton = document.createElement('button');
        prevButton.textContent = 'â—€ ì´ì „';
        prevButton.addEventListener('click', () => {
            currentPage--;
            fetchAndRenderUsers(); // ì‚¬ìš©ì ëª©ë¡ ë¦¬ë Œë”ë§
            fetchAndRenderChannels(); // ì±„ë„ ëª©ë¡ ë¦¬ë Œë”ë§
        });
        paginationElement.appendChild(prevButton);
    }

    // "ë‹¤ìŒ" ë²„íŠ¼
    if (currentPage < totalPages) {
        const nextButton = document.createElement('button');
        nextButton.textContent = 'ë‹¤ìŒ â–¶';
        nextButton.addEventListener('click', () => {
            currentPage++;
            fetchAndRenderUsers(); // ì‚¬ìš©ì ëª©ë¡ ë¦¬ë Œë”ë§
            fetchAndRenderChannels(); // ì±„ë„ ëª©ë¡ ë¦¬ë Œë”ë§
        });
        paginationElement.appendChild(nextButton);
    }
}
